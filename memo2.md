# frontendの役割

    - UIをつかさどる
    - 基本的な動きはgameStateをなんでもbackendで変更して変更後のデータを、Socketで受け取る。
    - Socketでデータを受け取ったことはuseEffectで検知して、gameStateの更新のたびに再レンダリングをする。

# backendの役割

    -   backendの役割は主に以下のように分けられる。
        -   Utility(GameFlowMonitor.ts)
            - StateのPhaseとActionと手持ちの動物、コイン、スター、サイコロの目等、の内容をチェックして
                ゲーム内で、プレイヤーが行うことができる動作かをチェックする。ゲームの状況を管理する。（チート対策のため）
    					- Phaseやターンを進める。
    					- 勝利/敗北を判定する。
        -   Service
            -   ゲームのサービスを提供する。
                - ゲーム上で行えるstateの変更、処理そのものが実装されている。
    							- 動物の効果発動もこの領域で行う
    					- Stateの返却を行う
    						- Service上で変更したstateの値を返却する。

# ゲーム全体の流れ

1. frontend で 操作が行われる
2. backendのソケットポイントを実行
3. データをUtilityでチェックする
4. ServiceでStateを修正する。
5. Serviceでデータを返却する。
6. frontendで5.の処理の変更を受け取り、stateに反映する
7. 6の変更をuseEffectで検知してgameStateに反映させる。

---

-   colorは動物の色を表します。
    Cageには規則があります。Cage内に最初に設置された動物(例えば、cage5ならcage5[0]など）の色を持つ動物しか、2体目以降は、配置できないというルールがあります。1体目の色と同じ色を持つ動物しか配置できません。

Webブラウザゲーム開発の専門家として回答してください。

これから難易度の高い実装を行うので、複数回に分けて結果を出力してもよいです。
動物の効果処理という機能を実装します。

# 動物の効果処理の流れ

1. 各プレイヤーがサイコロを振ったとき、それぞれのプレイヤーのBoard内にある、
   サイコロの値と同じ番号のCageの中身を確認します。

2. そのプレイヤーのCage内にいるAnimalの値を確認します。
   ※それぞれAnimalには様々なプロパティがあります。backendのsrc/types/Animalフォルダ内のtsにそれぞれのAnimalのプロパティが設定されています。

3. 例えばプレイヤー2がサイコロをプレイし、5の目が出るとします。
   そうした場合、プレイヤー全員のBoardのcage5の値を取得します。

4. cage5に入っている動物の効果を処理します。効果処理は、プレイヤーのコインやインベントリアイテムを増減させます。

5. 4の手順で行った効果処理をgameStateに反映して、frontendに返却します。

# 効果処理の仕様

全てのプレイヤーBoard内のAnimalを、プレイヤーごとに確認します。
gameState.playersの全てのBoard内に存在する、Animalをすべて取得します。
取得したAnimalのEffectプロパティの、timingとglobalプロパティを順に確認します。

-   globalがtrueの場合：「自分以外のプレイヤーのサイコロでも効果が発動」します
-   timingがfirstの場合:サイコロを振った次のプレイヤーから順に処理を行います。最後に自分の動物の効果を処理するようにします。
-   endの場合は、上記に記載した、全員の効果処理が終了した後に、効果処理を行います。

さらに、ほかの項目も確認します。

-   creationプロパティは、指定された枚数の、コインをプレイヤー付与します。このときglobalが付いていないとほかのプレイヤーのサイコロの値では発動しないことに注意して下さい。
-   creationIFは、下記の例のように、条件式を配列で持っています。

    -   例)Q：下記のようなプロパティの場合、どのような効果処理となるか。
        -   creationIf: ["Penguin", ">=", "2", "?", "2", ":", "1"],
    -   A: 自分のBoardのペンギンが2匹以上なら、2Coinを生成する。1体の場合、1Coinを生成する
    -   3項演算子またはNull合体演算子の条件式を表現し、プレイヤーにCoinを生成します。

-   buffは自身のBoardの動物の数を条件に、コインをプレイヤーに付与します。

    -   例Q：下記のようなプロパティの場合、どのような効果処理となるか。
        -   buff: [1, "RessaPanda", "each"]
        -   A: 自分のレッサーパンダの数だけ、自分のCoinを+1する eachは自分が所有する、第2引数の動物の数だけ（掛け算）第1引数のコインを生み出します。
        -   もしもbuff: [1, "RessaPanda", "once"]だった場合
        -   onceは自分が、第2引数の動物を所有していたら、Coinを（足し算）+1します

-   bonusbuffは、ほかの効果処理を行った後、加えて発動する処理です。

    -   例Q：下記のようなプロパティの場合、どのような効果処理となるか。
        -   bonusbuff: [1, "GiantPanda", "once"],
        -   A：自分のBoardにジャイアントパンダがいる場合、+1Coinする
        -   ここでの第3引数である、onceプロパティ「1回だけ、第一引数の数のコインを生成する」効果（足し算）になります。
        -   eachの場合は、自分のジャイアントパンダ1体につき＋1コインします（掛け算）

-   stealはほかのプレイヤーのコインを奪います。

    -   例：steal: [5, "target", 1],
        -   自分以外のプレイヤー1人指定をして5枚のコインを奪います。
        -   frontendにemitしてユーザを指定させるイベントを発生させます。

-   choiceは効果を選択して実行します。
    -   例：choice: ["creation", "steal"]
    -   どちらかを選択します。上記の例では、7枚のコインを取得するか、特定のプレイヤーを指定して5枚のコインを奪うかを選択します。
    -   frontendにemitして選択肢を選択させるイベントを発生させます。

# 実装してほしいこと

これまでに仕様を記載した、効果処理を行うclassをbackend側で作成してほしいです。
サイコロを実行した後に、この処理を呼び出す予定です。

# 添付ファイルについて

-   controllerとHandlerとServiceを添付します。
-   添付した実装のコーディングの傾向に対して、忠実に実装してください。
    実装を進めるうえで、質問事項があれば質問してください。

---

このゲームではサイコロの値と連動した、Cageに入っている動物の効果処理を行います。

効果処理はサイコロの値によって発動するしないが変わるので、テスト用GameBoardを作成したいです。
テストモードについての仕様を記載します。

# テストモード専用のパネル

gameStateを自由に変更できるパネルを作ってほしいです。
左Sidebarの位置に追加してください。

# 注意事項

-   dbで、直前のゲームデータを管理していて、不正な変更を検知しています。テストモードの場合その検知が行われないようにしてしてほしいです。
-   envファイルで、開発者かどうか判断できるようにしてほしいです。

## テストゲーム開始

-   この処理は現在の部屋のIDを持つ `room` テーブルのレコードの `data` を再作成（ゲーム開始時のデータで上書き）してください。

## プレイヤー追加

-   プレイヤー追加は、ゲーム開始前にのみ行えるようにしてください。
-   `frontend` で追加したいプレイヤー名の情報を `state` 管理して追加しておきます。ゲーム開始時に、`name` だけを入力した名前にして、最大3名まで追加できるようにしてください。

```typescript

```
